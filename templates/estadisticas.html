{% extends 'base.html' %}

{% block title %}üìà Estad√≠sticas{% endblock %}

{% block content %}
<h2>üìà Estad√≠sticas por Centro de Costo o Especialidad</h2>

<!-- FORMULARIOS -->
<form method="POST" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px;" onsubmit="return validarFiltros()">
    <!-- Centro de Costo -->
    <div>
        <label for="centro_costo">Selecciona un centro de costo:</label><br>
        <select name="centro_costo" id="centro_costo" style="width: 250px; padding: 8px;" onchange="desactivarEspecialidad()">
            <option value="">-- Todos --</option>
            {% for centro in centros_costo %}
                <option value="{{ centro }}" {% if centro == centro_seleccionado %}selected{% endif %}>{{ centro }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Especialidad -->
    <div>
        <label for="especialidad">Selecciona una especialidad:</label><br>
        <select name="especialidad" id="especialidad" style="width: 250px; padding: 8px;" onchange="desactivarCentroCosto()">
            <option value="">-- Todas --</option>
            {% for esp in especialidades %}
                <option value="{{ esp }}" {% if esp == especialidad_seleccionada %}selected{% endif %}>{{ esp }}</option>
            {% endfor %}
        </select>
    </div>

    <div style="align-self: flex-end;">
        <button type="submit">üîç Ver Estad√≠sticas</button>
    </div>
</form>

<!-- RESULTADOS -->
{% if datos %}
<div style="border: 1px solid #ccc; border-radius: 10px; padding: 20px; background-color: #f9f9f9;">
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead style="background-color: #e8e8e8;">
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>RUT</th>
                    <th>Horas Normales</th>
                    <th>Horas Extras</th>
                    <th>D√≠as Trabajados</th>
                    <th>Licencias</th>
                    <th>Permisos</th>
                    <th>Fallas</th>
                    <th>Vacaciones</th>
                </tr>
            </thead>
            <tbody>
                {% set tot_hn = 0 %}
                {% set tot_he = 0 %}
                {% set tot_dias = 0 %}
                {% set tot_L = 0 %}
                {% set tot_P = 0 %}
                {% set tot_F = 0 %}
                {% set tot_V = 0 %}
                {% for persona in datos %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ persona.nombre or 'Sin nombre' }}</td>
                    <td>{{ persona.apellido or 'Sin apellido' }}</td>
                    <td>{{ persona.rut }}</td>
                    <td>{{ persona.total_hn or 0 }}</td>
                    <td>{{ persona.total_he or 0 }}</td>
                    <td>{{ persona.dias_trabajados or 0 }}</td>
                    <td>{{ persona.licencias or 0 }}</td>
                    <td>{{ persona.permisos or 0 }}</td>
                    <td>{{ persona.fallas or 0 }}</td>
                    <td>{{ persona.vacaciones or 0 }}</td>
                </tr>
                {% set tot_hn = tot_hn + (persona.total_hn or 0) %}
                {% set tot_he = tot_he + (persona.total_he or 0) %}
                {% set tot_dias = tot_dias + (persona.dias_trabajados or 0) %}
                {% set tot_L = tot_L + (persona.licencias or 0) %}
                {% set tot_P = tot_P + (persona.permisos or 0) %}
                {% set tot_F = tot_F + (persona.fallas or 0) %}
                {% set tot_V = tot_V + (persona.vacaciones or 0) %}
                {% endfor %}
            </tbody>
            <tfoot style="background-color: #eef;">
                <tr>
                    <th colspan="4" style="text-align: right;">Totales:</th>
                    <th>{{ tot_hn }}</th>
                    <th>{{ tot_he }}</th>
                    <th>{{ tot_dias }}</th>
                    <th>{{ tot_L }}</th>
                    <th>{{ tot_P }}</th>
                    <th>{{ tot_F }}</th>
                    <th>{{ tot_V }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% elif centro_seleccionado or especialidad_seleccionada %}
<div style="margin-top: 20px; color: #555; font-weight: bold;">
    ‚ö†Ô∏è No se encontraron registros de horas para estos filtros.
</div>
{% else %}
<div style="margin-top: 20px; color: gray; font-style: italic;">
    ‚ÑπÔ∏è Pesta√±a en proceso. Selecciona un filtro para comenzar a ver estad√≠sticas.
</div>
{% endif %}

<script>
function desactivarEspecialidad() {
    document.getElementById('especialidad').selectedIndex = 0;
}
function desactivarCentroCosto() {
    document.getElementById('centro_costo').selectedIndex = 0;
}
function validarFiltros() {
    const centro = document.getElementById('centro_costo').value;
    const esp = document.getElementById('especialidad').value;
    if (centro && esp) {
        alert("Solo puedes seleccionar un filtro: Centro de Costo o Especialidad, no ambos.");
        return false;
    }
    return true;
}
</script>
{% endblock %}
