{% extends 'base.html' %}

{% block title %}Registrar Solicitud{% endblock %}

{% block content %}
<div class="contenedor-flex">
  <div class="formulario">
    <h2>ğŸ“ Registrar Solicitud</h2>
    <div style="background-color: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 5px; color: #856404; font-weight: bold; margin-bottom: 15px;">
    âš ï¸ Recuerda: Siempre debes cerrar la solicitud para una person antes de ingresar otra nueva!. 
      Debido a que no se pueden mezclar solicitudes de dos personas al mismo tiempo.
    </div>

    <form method="POST">
      <label>ğŸ‘¤ Nombre del Solicitante:</label>
      <input type="text" id="nombre_solicitante" name="nombre_solicitante" required value="{{ datos.get('nombre_solicitante', '') }}">

      <label>ğŸ†” RUT (sin puntos, con guiÃ³n):</label>
      <input type="text" id="rut_solicitante" name="rut_solicitante" pattern="^\d{7,8}-[\dkK]$" required value="{{ datos.get('rut_solicitante', '') }}">

      <label>ğŸ” Buscar Producto:</label>
      <input type="text" id="producto_nombre_buscar" placeholder="Escribe el nombre del producto" oninput="filtrarProductos()">

      <label>ğŸ“¦ Selecciona Producto (Nombre - Marca - NÂ° Serie):</label>
      <select name="producto_id" id="producto_id_select" onchange="actualizarDatosProducto()" required>
        <option value="">-- Selecciona un producto --</option>
        {% for producto in inventario %}
          <option value="{{ producto.id }}"
                  data-nombre="{{ producto.producto_nombre }}"
                  data-categoria="{{ producto.categoria}}"
                  data-marca="{{ producto.marca }}"
                  data-n_serie="{{ producto.n_serie }}"
                  data-stock="{{ producto.stock_disponible }}"
                  data-estado="{{ producto.estado }}"
                  data-precio="{{ producto.precio_unitario }}">
            {{ producto.producto_nombre }} - {{ producto.categoria }} - {{ producto.marca }} - {{ producto.n_serie }}
          </option>
        {% endfor %}
      </select>

      <label>CategorÃ­a:</label>
      <input type="text" id="categoria_producto" name="categoria_producto" readonly>

      <label>Marca:</label>
      <input type="text" id="marca_producto" name="marca_producto" readonly>

      <label>NÂ° Serie:</label>
      <input type="text" id="n_serie_producto" name="n_serie_producto" readonly>
      
      <label>ğŸ“Š Stock Disponible:</label>
      <input type="text" id="stock_disponible" disabled>

      <label>âš™ï¸ Estado del Producto:</label>
      <input type="text" id="estado_producto" disabled>

      <label>ğŸ“Š Cantidad:</label>
      <input type="number" name="cantidad" id="cantidad" min="1" required>

      <label>ğŸ’° Precio Unitario:</label>
      <input type="text" id="precio_unitario" disabled>

      <label>ğŸ¢ Centro de Costo:</label>
      <select name="id_proyecto" required>
        <option value="">Selecciona un centro de costo</option>
        {% for proyecto in proyectos %}
          <option value="{{ proyecto.id_proyecto }}">{{ proyecto.id_proyecto }} - {{ proyecto.nombre_proyecto }}</option>
        {% endfor %}
      </select>

      <label for="motivo">ğŸ“Œ Motivo:</label>
      <select id="motivo" name="motivo" required>
        <option value="">Seleccione</option>
        <option value="consumo">Consumo</option>
        <option value="devolucion">DevoluciÃ³n</option>
      </select>

      <button type="submit">â• Agregar Producto</button>
    </form>
  </div>

  <div class="lista-solicitudes">
    <h3>ğŸ“‹ Productos Agregados</h3>
    <ul class="productos-lista">
      {% for item in datos.get('productos', []) %}
        <li>
          <div>
            <strong>{{ item.producto_nombre }}</strong><br>
            CategorÃ­a: {{ item.categoria if item.categoria else 'No registrada' }}<br>
            Marca: {{ item.marca if item.marca else 'No registrada' }}<br>
            NÂ° Serie: {{ item.n_serie if item.n_serie else 'No registrado' }}<br>
            Cantidad: {{ item.cantidad }}<br>
            Precio Unitario: ${{ item.precio_unitario }}<br>
            ğŸ’° Total: ${{ item.precio }}<br>
            ğŸ¢ Centro de Costo: {{ item.centro_costo }} | ğŸ“Œ Motivo: {{ item.motivo }}
          </div>
          <a href="{{ url_for('eliminar_producto', index=loop.index0) }}" class="btn-eliminar">âŒ Eliminar</a>
        </li>
      {% endfor %}
    </ul>

    {% if datos.get('productos') %}
      <form method="GET" action="{{ url_for('confirmar_solicitud') }}">
        <button type="submit">âœ… Confirmar Solicitud</button>
      </form>
    {% endif %}

    <h3>âš ï¸ Historial de Alertas</h3>
    <ul class="alertas">
      {% with messages = get_flashed_messages() %}
        {% for message in messages %}
          <li class="alert {{ 'alert-grave' if 'âš ï¸' in message else '' }}">{{ message }}</li>
        {% endfor %}
      {% endwith %}
    </ul>
  </div>
</div>

<style>
.contenedor-flex {
  display: flex;
  gap: 20px;
}
.formulario, .lista-solicitudes {
  width: 50%;
  background-color: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.productos-lista li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.btn-eliminar {
  background-color: #e20000;
  color: white;
  padding: 5px;
  text-decoration: none;
  border-radius: 5px;
}
.alertas .alert {
  background-color: #ffb5b5;
  border: 1px solid #fd8f8f;
  padding: 8px;
  margin: 5px 0;
  border-radius: 5px;
}
.alert-grave {
  background-color: #f8b2b2;
  color: rgb(0, 0, 0);
  font-weight: bold;
  border: 2px solid #ffb4b4;
  box-shadow: 0 0 15px rgba(255, 202, 202, 0.7);
  text-align: center;
  margin-top: 20px;
  padding: 20px;
  font-size: 18px;
}
</style>

<script>
// --- FUNCIÃ“N DE FILTRADO (LÃ³gica replicada de Entradas) ---
function filtrarProductos() {
    const input = document.getElementById('producto_nombre_buscar').value.toLowerCase();
    const select = document.getElementById('producto_id_select');
    const opciones = select.options;

    for (let i = 0; i < opciones.length; i++) {
        // Obtenemos el texto del producto (Nombre - Marca - Serie)
        const textoProducto = opciones[i].text.toLowerCase();
        const match = textoProducto.includes(input);
        
        // Mostrar si hay coincidencia o si es la opciÃ³n por defecto
        opciones[i].style.display = match || opciones[i].value === "" ? "" : "none";
    }
}

// --- FUNCIÃ“N DE ACTUALIZACIÃ“N DE DATOS ---
function actualizarDatosProducto() {
    const select = document.getElementById("producto_id_select");
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption.value !== "") {
        // Extraer datos de los atributos data-
        document.getElementById("categoria_producto").value = selectedOption.getAttribute("data-categoria") || "";
        document.getElementById("marca_producto").value = selectedOption.getAttribute("data-marca") || "";
        document.getElementById("n_serie_producto").value = selectedOption.getAttribute("data-n_serie") || "";
        document.getElementById("stock_disponible").value = selectedOption.getAttribute("data-stock") || "0";
        document.getElementById("estado_producto").value = selectedOption.getAttribute("data-estado") || "";
        document.getElementById("precio_unitario").value = selectedOption.getAttribute("data-precio") || "0";
    } else {
        // Limpiar campos si no hay selecciÃ³n
        document.getElementById("categoria_producto").value = "";
        document.getElementById("marca_producto").value = "";
        document.getElementById("n_serie_producto").value = "";
        document.getElementById("stock_disponible").value = "";
        document.getElementById("estado_producto").value = "";
        document.getElementById("precio_unitario").value = "";
    }
}

// BLOQUE DE AUTOCOMPLETADO DE RUT (Existente)
document.getElementById('nombre_solicitante').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
    const nombreSeleccionado = this.value.trim();
    const rutInput = document.getElementById('rut_solicitante');

    if (nombreSeleccionado.length > 5) {
        fetch(`/obtener_rut_solicitante?nombre=${encodeURIComponent(nombreSeleccionado)}`)
            .then(response => response.json())
            .then(data => {
                if (data.rut) {
                    rutInput.value = data.rut;
                    rutInput.style.border = "2px solid #28a745";
                } else {
                    rutInput.value = "";
                    rutInput.style.border = "1px solid #ccc";
                }
            })
            .catch(error => console.error('Error:', error));
    } else {
        rutInput.value = "";
        rutInput.style.border = "1px solid #ccc";
    }
});
</script>

{% endblock %}